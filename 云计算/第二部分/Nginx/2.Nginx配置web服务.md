
# 一.语法结构

```bash title:配置文件目录
/usr/local/nginx/conf/nginx.conf
```

![[Excalidraw/Drawing 2024-05-28 21.17.27.excalidraw.md#^group=cIzlvxLfDm--KJ4KOs2VR|500]]

## 1.全局配置

![[Pasted image 20240528141829.png|301]]
### (1)user xxx
<span style="background:#affad1">定义工作进程的用户</span>
![[Pasted image 20240528130553.png|300]]
```bash
useradd -s /sbin/nologin suiyi
/usr/local/nginx/sbin/nginx -s reload
ps -elf | grep nginx
```
![[Pasted image 20240528130752.png|700]]
> [!注意] 
> 这个进程对应的用户改了影响什么？
> 影响权限！要确认你这个用户，最起码对这个网页有读的权限
### (2)work_processes
<span style="background:#affad1">定义启动时，工作进程的数量</span>
![[Pasted image 20240528131514.png|302]]

nginx的优化参数，指定nginx启动之后，默认启动几个工作进程，来接受处理客户端的请求
增大可以提高性能，建议和cpu数量一致或者为cpu数量的2倍，也不能过大，容易造成阻塞内存浪费
```bash title:查看cpu参数
lscpu
```
![[Pasted image 20240528132355.png|307]]

```bash title:显示cpu核数
nproc
```
![[Pasted image 20240528132731.png|700]]

### (3)error_log
<span style="background:#affad1">定义错误日志</span>
![[Pasted image 20240528132913.png|500]]
后面的选项指定<span style="background:#affad1">错误日志的级别的</span>
[nginx documentation](https://nginx.org/en/docs/)
![[Pasted image 20240528133338.png|500]]
<span style="background:#affad1">八种级别</span>
轻度
`debug`, `info`, `notice`, `warn`,
重度
`error`, `crit`, `alert`, or `emerg`.

### (4)pid
<span style="background:#affad1">定义pid文件</span>
```bash
cat /use/local/nginx/logs/nginx.pid
```
![[Pasted image 20240528134145.png|700]]

## 2.事件驱动模型

| 名称                 | 作用                              |
| ------------------ | ------------------------------- |
| use epoll          | nginx装载红帽的系统上，它默认的事件驱动模型就是epoll |
| worder_connections | 指定nginx的每个工作进程指定的最大连接数          |
![[Pasted image 20240528134940.png|489]]
## 3.http公共配置

![[Pasted image 20240528141728.png|500]]

### (1)include
<span style="background:#affad1">mime: 定义能够支持传输那些非文本数据</span>
```bash
cat mime.types
```
![[Pasted image 20240528140352.png|700]]

### (2)log_format
<span style="background:#affad1">定义访问日志/访问日志格式</span>
![[Pasted image 20240528140621.png|700]]
<span style="background:#affad1">变量说明：</span>

| 变量               | 作用                 |
| ---------------- | ------------------ |
| $remote_addr     | 客户端地址              |
| $time_local      | 时间                 |
| $request         | 请求方法 请求资源 http协议版本 |
| $status          | 状态码                |
| $body_bytes_sent | 响应数据大小             |
| $http_referer    | 超链接地址              |
| $http_user_agent | 客户端系统、浏览器类型        |

### (3)sendfile
<span style="background:#affad1">启用sendfile机制</span>
实现零拷贝，内核读取到数据后，直接放入web进程的内存空间
### (4)keepalive_timeout
<span style="background:#affad1">长连接keepalive,长连接,一条连接发送多次请求</span>
keepalive_timeout 65;       //长连接的超时时间 
keepalive_requests 1000;  //最大请求数
### (5)gzip
<span style="background:#affad1">启用gzip压缩</span>

## 5.虚拟主机配置

- 虚拟主机类型
	- 基于名称的虚拟主机  
	- 基于IP的虚拟主机

### (1)基于名称的虚拟主机配置

规划：music.linux.com
网页目录：/music

```bash title:创建子配置文件
mkdir /usr/local/nginx/conf.d
vim /usr/local/nginx/conf.d/music.conf
```
![[Pasted image 20240528150740.png|500]]
```bash title:虚拟主机的配置
server{
   listen 80;
   server_name music.linux.com;
   error_log /usr/lcoal/nginx/logs/music_error.log error;
   access_log /usr/local/nginx/logs/music_access.log main;
   
   location / {
   root /music;
   index index.html;
   }
}
```

```bash
mkdir /music
cd /music/
vim index.html
```
自己建的子配置文件，想让他生效，必须在nginx.conf中加载一下这个子配置文件

#### 错误做法
```bash
vim /usr/local/nginx/conf/nginx.conf
```
![[Pasted image 20240528145140.png]]

检查语法有没有错误
/usr/local/nginx/sbin/nginx -t
![[Pasted image 20240528145912.png]]
```ad-error
报错！
```

#### 正确做法

修改配置文件
![[Pasted image 20240528150006.png]]
放到这个main配置下面，他是按着自上而下的方式读取配置文件，如果放在main格式前面，
就会读取到未知的main格式从而报错

```bash
/usr/local/nginx/sbin/nginx -t
```
![[Pasted image 20240528150820.png]]
```ad-success
检查成功
```
```bash title:重新加载配置文件
/usr/local/nginx/sbin/nginx -s reload 
```

#### 客户端访问成功

客户端访问，客户端在hosts文件，添加dns地址解析
但是访问失败！
![[Pasted image 20240528161432.png|275]]

经过排查是因为客户端开了vpn，把vpn关掉即可正常访问
![[Pasted image 20240528161755.png|325]]





### (2)基于IP地址的虚拟机配置

添加一个网卡，配置好ip地址
![[Pasted image 20240528164947.png]]

添加一个测试界面
```bash 
/vedio/index.html
vim   /usr/local/nginx/conf.d/vedio.cnf
```
![[Pasted image 20240528170905.png]]

```bash title:加载在主配置文件
vim /usr/local/nginx/conf/nginx.conf
```
![[Pasted image 20240528171032.png]]

```bash title:检查语法/重新加载
/usr/local/nginx/sbin/nginx -t
/usr/local/nginx/sbin/nginx -s reload
```

客户端测试
![[Pasted image 20240528171144.png|340]]
 