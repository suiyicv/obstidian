
# 一.haproxy介绍

开源、[负载均衡器](https://so.csdn.net/so/search?q=%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8&spm=1001.2101.3001.7020)  
同时支持4层负载、7层负载

1.负载均衡类型

4层负载 传输层 tcp/udp 端口号
根据IP/port进行负载、调度  
[LVS](https://so.csdn.net/so/search?q=LVS&spm=1001.2101.3001.7020)、nginx(stream模块)

7层负载 
针对http/https协议进行负载， 灵活性高  
根据应用层数据(图片、视频、动画等)进行调度  
[nginx](https://so.csdn.net/so/search?q=nginx&spm=1001.2101.3001.7020)(upstream模块)

# 二.haproxy配置文件

 yum -y install haproxy
 ls /etc/haproxy/
![[Pasted image 20240611224905.png]]
cat /etc/haproxy/haproxy.cfg

## 1.backend
定义后端业务服务器
```bash
backend xxxx
	balance roundrobin			# 调度算法
	mode {tcp|http}				    # tcp：4层负载、http: 7层负载
	server 名称 IP:port check
	server 名称 IP:port check
```
## 2.frontend
定义虚拟服务
```bash
frontend 虚拟服务名称
	bind IP:port
	mode {tcp|http}
	use_backend backend后端服务器
```

# 三.haproxy实现MySQL负载均衡 —— 4层

![[Pasted image 20240611225941.png]]
 负载均衡要考虑数据的一致性
 负载均衡的东西，要有一定的关系
## 1.后端两台MySQL配置双主复制
192.168.137.150
vim /etc/my.cnf
server_id = 150
log_bin = master
systemctl restart mysqld
mysql -uroot -pWWW.1.com
create user 'repluser'@'%' identified by 'WWW.1.com';
grant replication slave on *.* to 'repluser'@'%';
flush privileges;
mysqldump -uroot -pWWW.1.com --lock-all-tables --master-data=2 --all-databases > /opt/data.sql
scp /opt/data.sql root@192.168.137.151:/opt/

192.168.137.151
vim /etc/my.cnf
server_id = 151
log_bin = master
systemctl restart mysqld
mysql -uroot -pWWW.1.com < /opt/data.sql
vim /etc/data.sql
![[Pasted image 20240611234546.png]]
mysql> change master to
    -> master_host="192.168.137.150",
    -> master_user="repluser",
    -> master_password="WWW.1.com",
    -> master_log_file="master.000001",
    -> master_log_pos=755;
mysql> start slave;
此时：150主151从
在主上创建个用户
grant replication slave on *.* to 'repluser'@'192.168.137.150' identified by "WWW.1.com";


## 2.安装配置haproxy