
# 一.语法结构

```bash title:配置文件目录
/usr/local/nginx/conf/nginx.conf
```

![[Excalidraw/Drawing 2024-05-28 21.17.27.excalidraw.md#^group=cIzlvxLfDm--KJ4KOs2VR|500]]

## 1.全局配置

![[Pasted image 20240528141829.png|301]]
### (1)user xxx
<span style="background:#affad1">定义工作进程的用户</span>
![[Pasted image 20240528130553.png|300]]
```bash
useradd -s /sbin/nologin suiyi
/usr/local/nginx/sbin/nginx -s reload
ps -elf | grep nginx
```
![[Pasted image 20240528130752.png|700]]
> [!注意] 
> 这个进程对应的用户改了影响什么？
> 影响权限！要确认你这个用户，最起码对这个网页有读的权限
### (2)work_processes
<span style="background:#affad1">定义启动时，工作进程的数量</span>
![[Pasted image 20240528131514.png|302]]

nginx的优化参数，指定nginx启动之后，默认启动几个工作进程，来接受处理客户端的请求
增大可以提高性能，建议和cpu数量一致或者为cpu数量的2倍，也不能过大，容易造成阻塞内存浪费
```bash title:查看cpu参数
lscpu
```
![[Pasted image 20240528132355.png|307]]

```bash title:显示cpu核数
nproc
```
![[Pasted image 20240528132731.png|700]]

### (3)error_log
<span style="background:#affad1">定义错误日志</span>
![[Pasted image 20240528132913.png|500]]
后面的选项指定<span style="background:#affad1">错误日志的级别的</span>
[nginx documentation](https://nginx.org/en/docs/)
![[Pasted image 20240528133338.png|500]]
<span style="background:#affad1">八种级别</span>
轻度
`debug`, `info`, `notice`, `warn`,
重度
`error`, `crit`, `alert`, or `emerg`.

### (4)pid
<span style="background:#affad1">定义pid文件</span>
```bash
cat /use/local/nginx/logs/nginx.pid
```
![[Pasted image 20240528134145.png|700]]

## 2.事件驱动模型

| 名称                 | 作用                              |
| ------------------ | ------------------------------- |
| use epoll          | nginx装载红帽的系统上，它默认的事件驱动模型就是epoll |
| worder_connections | 指定nginx的每个工作进程指定的最大连接数          |
epoll 高效的 I/O 多路复用机制，它非常适合处理大量并发连接
![[Pasted image 20240528134940.png|489]]
## 3.http公共配置

![[Pasted image 20240528141728.png|500]]

### (1)include
<span style="background:#affad1">mime: 定义能够支持传输那些非文本数据</span>
```bash
cat mime.types
```
![[Pasted image 20240528140352.png|700]]

### (2)log_format
<span style="background:#affad1">定义访问日志/访问日志格式</span>
![[Pasted image 20240528140621.png|700]]
<span style="background:#affad1">变量说明：</span>

| 变量               | 作用                 |
| ---------------- | ------------------ |
| $remote_addr     | 客户端地址              |
| $time_local      | 时间                 |
| $request         | 请求方法 请求资源 http协议版本 |
| $status          | 状态码                |
| $body_bytes_sent | 响应数据大小             |
| $http_referer    | 超链接地址              |
| $http_user_agent | 客户端系统、浏览器类型        |

### (3)sendfile
<span style="background:#affad1">启用sendfile机制</span>
实现零拷贝，内核读取到数据后，直接放入web进程的内存空间
### (4)keepalive_timeout
<span style="background:#affad1">长连接keepalive,长连接,一条连接发送多次请求</span>
keepalive_timeout 65;       //长连接的超时时间 
keepalive_requests 1000;  //最大请求数
长连接的概念
https://lxblog.com/qianwen/share?shareId=1b6ba6dd-6e7b-4735-a811-92bfb4eb8011

### (5)gzip
<span style="background:#affad1">启用gzip压缩</span>

# 二.虚拟主机配置

- 虚拟主机类型
	- 基于名称的虚拟主机  
	- 基于IP的虚拟主机
## (1)基于名称的虚拟主机配置

规划：music.linux.com
网页目录：/music

```bash title:创建子配置文件
mkdir /usr/local/nginx/conf.d
vim /usr/local/nginx/conf.d/music.conf
```
![[Pasted image 20240528150740.png|500]]
```bash title:虚拟主机的配置
server{
	listen 80;
	server_name music.linux.com;
	error_log /usr/lcoal/nginx/logs/music_error.log error;
	access_log /usr/local/nginx/logs/music_access.log main;
	location / {
		root /music;
		index index.html;
	}
}
```

```bash
mkdir /music
cd /music/
vim index.html
```

自己建的子配置文件，想让他生效，<span style="background:#affad1">必须在nginx.conf中加载一下这个子配置文件</span>

### 错误做法
```bash
vim /usr/local/nginx/conf/nginx.conf
```
![[Pasted image 20240528145140.png]]

检查语法有没有错误
```bash
/usr/local/nginx/sbin/nginx -t
```
![[Pasted image 20240528145912.png]]
```ad-error
报错！
```

### 正确做法

修改配置文件
![[Pasted image 20240528150006.png]]
放到这个main配置下面，他是按着自上而下的方式读取配置文件，如果放在main格式前面，
就会读取到未知的main格式从而报错

```bash title:检查语法
/usr/local/nginx/sbin/nginx -t
```
![[Pasted image 20240528150820.png]]
```ad-success
检查成功
```
```bash title:重新加载配置文件
/usr/local/nginx/sbin/nginx -s reload 
```

### 客户端访问成功

客户端访问，客户端在hosts文件，添加dns地址解析
但是访问失败！
![[Pasted image 20240528161432.png|400]]

经过排查是因为客户端开了vpn，把vpn关掉即可正常访问
![[Pasted image 20240528161755.png|400]]

## (2)基于IP地址的虚拟机配置

### 1.添加一个网卡，配置好ip地址
![[Pasted image 20240528164947.png]]

### 2.添加一个测试界面
```bash 
mkdir /vedio
vim /vedio/index.html
```
### 3.配置虚拟主机
```bash
vim   /usr/local/nginx/conf.d/vedio.cnf
```
![[Pasted image 20240528170905.png|450]]

```bash title:加载在主配置文件里
vim /usr/local/nginx/conf/nginx.conf
```
![[Pasted image 20240528171032.png]]

```bash title:检查语法/重新加载
/usr/local/nginx/sbin/nginx -t
/usr/local/nginx/sbin/nginx -s reload
```

### 4.客户端测试
![[Pasted image 20240528171144.png|315]]


# 三.https的虚拟主机

<span style="background:#affad1">证书/密钥</span>

## 1.获取证书的方式

- 业务发布到互联网，合法的CA机构申请证书(云平台)
- 私有CA
## 2.部署私有CA

### (1)创建CA的数据库文件
```bash
touch /etc/pki/CA/index.txt
echo 01 > /etc/pki/CA/serial
```
### (2)创建密钥对
```bash
openssl genrsa -out /etc/pki/CA/private/cakey.pem 1024
```
![[Pasted image 20240529190752.png]]
### (3)创建自签证书
```bash
openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -out /etc/pki/CA/cacert.pem -days 3650
```
![[Pasted image 20240529191001.png]]
![[Pasted image 20240529191145.png]]



## 3.部署https网站
### 3.1申请证书
#### (1)生成密钥
```bash
mkdir /usr/local/nginx/ssl
cd /usr/local/nginx/ssl
openssl genrsa -out secure.linux.com.key 1024
```
![[Pasted image 20240529191721.png]]
#### (2)创建证书申请
```bash
openssl req -new -key secure.linux.com.key -out secure.linux.com.csr
```
![[Pasted image 20240529192344.png]]

#### (3)将证书申请发送到CA
```bash
 ls
```
![[Pasted image 20240529192556.png]]
```bash
scp secure.linux.com.csr root@192.168.1.21:/opt/
```
![[Pasted image 20240529192614.png]]

#### (4)CA签发证书
```bash
openssl ca -in /opt/secure.linux.com.csr -out /etc/pki/CA/certs/secure.linux.com.crt -days 3650
```
![[Pasted image 20240529192939.png]]

#### (5)CA签订好的证书发送到网站服务器
```bash
scp /etc/pki/CA/certs/secure.linux.com.crt root@192.168.1.10:/usr/local/nginx/ssl
```
![[Pasted image 20240529193347.png]]

### 3.2部署虚拟主机
```bash
mkdir /secure
vim /secure/index.html
vim /usr/local/nginx/conf.d/secure.conf
```
![[Pasted image 20240529193726.png]]
```bash
vim /usr/local/nginx/conf/nginx.conf
```
![[Pasted image 20240529194039.png]]
```bash
/usr/local/nginx/sbin/nginx -t
```
![[Pasted image 20240529194428.png]]
```ad-error
报错！
nginx 是一个模块化的软件，装软件的时候没装ssl模块，所以不支持https的配置的，需要重新安装一下
```

#### (1)重装nginx

进入到软件包目录
```bash
cd nginx-1.20.2
ls
```
![[Pasted image 20240529195147.png]]

查找需要安装的模块
```bash
./configure --help | grep ssl
```
![[Pasted image 20240529195235.png]]

查看以前的安装的模块
```bash
/usr/local/nginx/sbin/nginx -V
```
![[Pasted image 20240529195314.png]]

重新编译安装
```bash
./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module
make
make install
```
```ad-success
重装完成
```

#### (2)再次检查配置语法
```bash
/usr/local/nginx/sbin/nginx -t
```
![[Pasted image 20240529195921.png]]
```bash
/usr/local/nginx/sbin/nginx -s reload
```

#### (3)查看端口
```bash
netstat -tunlp |grep nginx
```
![[Pasted image 20240529200144.png]]
发现并没有443端口，发生错误

关闭重启端口启动成功
```bash
/usr/local/nginx/sbin/nginx -s stop
/usr/local/nginx/sbin/nginx
netstat -tunlp |grep nginx
```
![[Pasted image 20240529200425.png]]

#### (4)客户端添加解析
```bash
192.168.1.10 secure.linux.com
```
#### (5)客户端访问
https://secure.linux.com
![[Pasted image 20240529201041.png]]