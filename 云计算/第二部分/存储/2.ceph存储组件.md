[ceph存储组件-CSDN博客](https://blog.csdn.net/u010198709/article/details/139670264?spm=1001.2014.3001.5501)

# ceph-mimic版本部署

1、环境规划
192.168.137.11 node01 ceph集群节点/ceph-deploy /dev/sdb
第一个机器装自动化工具
192.168.137.12 node02 ceph集群节点 /dev/sdb
192.168.137.13 node03 ceph集群节点 /dev/sdb
192.168.137.14 业务服务器

2.系统基础环境
2.1 关闭防火墙、SELinux
2.2 确保所有主机时间同步，写成计划任务
![[Pasted image 20240617151113.png]]
2.3所有主机ssh免密
![[Pasted image 20240617151143.png]]
mv /root/.ssh/id_rsa.pub /root/.ssh/authorized_keys
scp -r /root/.ssh/ root@192.168.137.12:/root/
scp -r /root/.ssh/ root@192.168.137.13:/root/
scp -r /root/.ssh/ root@192.168.137.14:/root/

验证免密
for i in 11 12 13 14
do
ssh root@192.168.137.$i hostname
ssh root@192.168.137.$i date
done
![[Pasted image 20240617152009.png]]

2.4 添加所有主机解析

192.168.137.11 node01
192.168.137.12 node02
192.168.137.13 node03
192.168.137.14 app

for i in 11 12 13 14
do
scp /etc/hosts root@192.168.137.$i:/etc/hosts
done
![[Pasted image 20240617153108.png]]

3.配置ceph软件仓库
wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
vim /etc/yum.repos.d/ceph.repo
```bash title:ceph.repo
[ceph]
name=ceph
baseurl=http://mirrors.aliyun.com/ceph/rpm-mimic/el7/x86_64/
enabled=1
gpgcheck=0
priority=1
 
[ceph-noarch]
name=cephnoarch
baseurl=http://mirrors.aliyun.com/ceph/rpm-mimic/el7/noarch/
enabled=1
gpgcheck=0
priority=1
 
[ceph-source]
name=Ceph source packages
baseurl=http://mirrors.aliyun.com/ceph/rpm-mimic/el7/SRPMS
enabled=1
gpgcheck=0
priority=1
```
3.1 为所有机器配置yum源
for i in 12 13 14
do 
scp /etc/yum.repos.d/ceph.repo root@192.168.137.$i:/etc/yum.repos.d/
done

3.2可做可不做
yum update 
reboot


4.安装ceph-deploy工具
第一个机器
```bash
yum install -y ceph-deploy 
```
5.ceph集群初始化
```bash
mkdir /etc/ceph
cd /etc/ceph
```
ImportError: No module named pkg_resources初始化时提示错误，安装yum install -y python2-pip
![[Pasted image 20240617155105.png]]
ceph-deploy new node01
![[Pasted image 20240617155401.png]]


生成一下文件
![[Pasted image 20240617155433.png|1000]]
ceph.conf：配置文件 
ceph-deploy-ceph.log：日志文件 
ceph.mon.keyring：ceph mon组件通信时的认证令牌

6.所有ceph集群<span style="background:#affad1">节点</span>安装相关软件
yum install -y ceph ceph-radosgw 
ceph -v
![[Pasted image 20240617161418.png|800]]


7.客户端安装ceph-common软件
yum install -y ceph-common

## 8.在ceph集群中创建ceph monitor组件
### 8.1 在配置文件中添加public network配置
vim ceph.conf
![[Pasted image 20240617162113.png]]

8.2在node01节点创建MON服务
ceph-deploy mon create-initial
出错的话删掉重新装
netstat -tunlp | grep ceph-mon
![[Pasted image 20240617164903.png|625]]
ls
![[Pasted image 20240617164828.png]]
ceph health
![[Pasted image 20240617164813.png]]


8.3 在所有ceph集群节点上同步配置
ceph-deploy admin node01 node02 node03
![[Pasted image 20240617165136.png]]
在其他节点查看配置，验证是否同步成功
ls /etc/ceph/
![[Pasted image 20240617165401.png]]
8.4 为避免MON的单点故障，在另外两个节点添加MON服务
在node01这个节点输入
ceph-deploy mon add node02
ceph-deploy mon add node03

8.4 查看ceph集群状态
ceph -s
![[Pasted image 20240617165630.png]]


## 9.创建mgr服务
ceph自L版本后，添加Ceph Manager Daemon，简称ceph-mgr  
该组件的出现主要是为了缓解ceph-monitor的压力，分担了moniotr的工作，例如插件管理等，以更好的管理集群

### 9.1 在node01节点创建mgr
ceph-deploy mgr create node01
netstat -tunlp | grep ceph-mgr
![[Pasted image 20240617170124.png]]

### 9.2 添加多个mgr
ceph-deploy mgr create node02
ceph-deploy mgr create node03
### 9.3 再次查看集群状态
ceph -s
![[Pasted image 20240617170225.png]]
## 10.添加osd
### 10.1 磁盘初始化
ceph-deploy disk zap node01 /dev/sdb
ceph-deploy disk zap node02 /dev/sdb
ceph-deploy disk zap node02 /dev/sdb

### 10.2 添加osd服务
ceph-deploy osd create --data /dev/sdb node01 
ceph-deploy osd create --data /dev/sdb node02 
ceph-deploy osd create --data /dev/sdb node03 
netstat -tunlp | grep osd

### 10.3 再次查看集群状态
ceph -s


集群扩容的流程(加osd）：  
1、准备系统基础环境  
2、新节点安装ceph, ceph-radosgw软件  
3、同步配置文件到新节点  
4、磁盘初始化，添加osd