# 一.keepalived高可用介绍

解决单点故障，提升服务高可用

基于VRRP协议设计
原理：
将多个物理设备放入到一个VRRP组中，通过VRRP组形成浮动IP，通过优先级进行主备选举，优先级高为主，浮动IP会配置到主设备上，同时主设备会发送心跳以通知自己的状态，备设备连续一段时间接收不到心跳，则认为主宕机，会自动接替主的工作

心跳：
默认以组播的方式发送心跳，地址224.0.0.18
影响心跳的因素：
1、防火墙
2、时间不同步
3、网络堵塞，多块网卡分担流量

# 二.keepalived高可用设计

![[Pasted image 20240612143718.png]]
## 1.两台haproxy负载均衡器配置一致

客户端通过DNS解析两台haproxy都可正常访问业务
有相同的服务配置
scp /etc/haproxy/haproxy.cfg
root@192.168.137.131:/etc/haproxy/haproxy.cfg
systemctl restart haproxy

虽然现在设置好了两个haproxy，但是他们现在是独立的，没有任何关系。

## 2.在haproxy上分别安装keepalived

```bash
yum install -y keepalived
```

## 3.配置keepalived实现高可用

规划浮动IP：192.168.137.100
192.168.137.130 当主
192.168.137.131 当备

192.168.137.130
vim  /etc/keepalived/keepalived.conf
![[Pasted image 20240613013319.png]]

192.168.137.131
vim  /etc/keepalived/keepalived.conf
![[Pasted image 20240613013557.png]]

## 4.两边都启动一下keepalived
systemctl enable --now keepalived


## 5.分别在两个调度器上查看浮动IP

192.168.137.130 有
![[Pasted image 20240613014002.png]]
192.168.137.131 无

以浮动ip，客户端设置dns解析
![[Pasted image 20240613014207.png]]
客户端访问测试
![[Pasted image 20240613014257.png]]

## 6.模拟故障，将优先级高的设备停机，测试客户端还可正常访问

192.168.137.130
systemctl stop keepalived
192.168.137.131
![[Pasted image 20240613014609.png]]
浮动ip在192.168.130.131上重新生成

业务依然可以访问
![[Pasted image 20240613014653.png]]

## 7.配置脚本，检测虚拟服务故障，实现浮动IP转移

我们通过keepalived做高可用，我们的机器故障了，浮动ip会在备上重新生成，不影响业务的正常访问
如果机器没挂，但是机器身上的<span style="background:#affad1">虚拟服务没了</span>，这个浮动ip会不会转移？
192.168.137.130
systemctl stop haproxy # 模拟虚拟服务消失
![[Pasted image 20240613015445.png]]
浮动ip还在，并且没有转移到192.168.137.131
![[Pasted image 20240613015524.png]]
此时业务无法访问

为什么我们的虚拟服务没了，但是浮动ip没有转移
应为这个浮动ip的功能是keepalived提供的，只要keepalived正常运行，这个浮动ip就不会发生变化

所以， 我们使用keepalived给这种负载均衡器做高可用的时候，除了需要考虑整个机器故障的问题，还要考虑如果虚拟服务挂了，也得让keepalived挂掉，
这样子才能正常的转移浮动ip到备上，实现前端业务的正常访问

所以需要我们写一个脚本
vim /etc/keepalived/check_haproxy.sh
![[Pasted image 20240613020638.png]]
chmod a+x /etc/keepalived/check_haproxy.sh

接下来让keepalived这个软件来周期性的调用执行我们的这个脚本

vim /etc/keepalived/keepalived.conf
![[Pasted image 20240613021804.png]]
![[Pasted image 20240613021413.png]]

scp /etc/keepalived/check_haproxy.sh root@192.168.137.131:/etc/